<script>
// ‚úÖ Get a fresh Nonce when the page loads
fetch('/wp-admin/admin-ajax.php?action=get_meme_nonce')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById("memeUploadNonce").value = data.data.nonce;
        }
    })
    .catch(error => console.error("Nonce Error:", error));

// ‚úÖ Check if IP has reached limit for a specific action and page
async function checkIpLimit(actionType, pageTitle) {
    const encodedTitle = encodeURIComponent(pageTitle);
    const response = await fetch(`/wp-admin/admin-ajax.php?action=check_ip_limit&action_type=${actionType}&page_title=${encodedTitle}`);
    const data = await response.json();
    return data.allowed;
}

// ‚úÖ Disable buttons if IP limit reached on page load
async function enforceIpLimitsOnLoad() {
    const pageTitle = document.title;

    // Check upload limit
    const uploadAllowed = await checkIpLimit('upload', pageTitle);
    if (!uploadAllowed) {
        document.getElementById("uploadMemeButton").disabled = true;
        document.getElementById("uploadStatus").innerText = `‚ùå Upload limit reached for "${pageTitle}". You can only upload one meme every 12 hours.`;
    } else {
        document.getElementById("uploadMemeButton").disabled = false;
	}

    // Check email limit
    const emailAllowed = await checkIpLimit('email', pageTitle);
    if (!emailAllowed) {
        document.getElementById("emailMemeButton").disabled = true;
        document.getElementById("uploadStatus").innerText += `\n‚ùå Email limit reached for "${pageTitle}". You can only send one email every 12 hours.`;
    } else {
        document.getElementById("emailMemeButton").disabled = false;
	}
    document.getElementById("twitterMemeButton").disabled = false;
}

// ‚úÖ Run limit checks immediately after page load
document.addEventListener("DOMContentLoaded", enforceIpLimitsOnLoad);

// ‚úÖ Log successful action after upload or email
async function logIpAction(actionType, pageTitle) {
    const encodedTitle = encodeURIComponent(pageTitle);
    await fetch(`/wp-admin/admin-ajax.php?action=log_ip_action&action_type=${actionType}&page_title=${encodedTitle}`);
}

// ‚úÖ Clear limits for testing
async function clearLimits() {
    const response = await fetch('/wp-admin/admin-ajax.php?action=clear_ip_limits');
    const data = await response.json();

    if (data.success) {
        alert("‚úÖ Limits cleared successfully.");
        document.getElementById("uploadStatus").innerText = "‚úÖ Limits cleared. You can test again.";
        await enforceIpLimitsOnLoad();
    } else {
        alert("‚ùå Failed to clear limits.");
    }
}

// ‚úÖ Email Function
async function emailMeme() {
	disableAllButtons();

	const pageTitle = document.title;
	const emailAllowed = await checkIpLimit('email', pageTitle);
	const fileInput = document.getElementById("memeFile");
	const file = fileInput.files[0];
	const postContent = document.getElementById("postContent").value.trim();
	const previewImage = document.getElementById("imagePreview").src;
	
	if (!file) {
		console.error("No file selected.");
		document.getElementById("uploadStatus").innerText = "‚ùå Please select a file.";
        await restoreButtons(); // üî• Restore all buttons
		return;
	}
	if (!postContent) {
		console.error("No post content provided.");
		document.getElementById("uploadStatus").innerText = "‚ùå Please enter some text for your post.";
        await restoreButtons(); // üî• Restore all buttons
		return;
	}
	if (!await validateBeforeAction("email")) {
        await restoreButtons(); // üî• Restore all buttons
		return;
	}
    if (!visionCheckPassed) {
        document.getElementById("uploadStatus").innerText = "‚ùå You must select a valid image first.";
        await restoreButtons(); // üî• Restore all buttons
        return;
    }

	if (!emailAllowed) {
		document.getElementById("uploadStatus").innerText = `‚ùå Email limit reached for "${pageTitle}". You can only send one email every 12 hours on this page.`;
        await restoreButtons(); // üî• Restore all buttons
		return;
	}

	try {
		let pasteInstructions = "The meme could not be copied automatically. Please attach the meme manually.\n\nHighlight and delete these instructions before attaching your meme.\n\n";

		// Attempt to copy the image to clipboard
		const response = await fetch(previewImage);
		const blob = await response.blob();

		if (navigator.clipboard && navigator.clipboard.write) {
			await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
			pasteInstructions = "The meme has been copied to your clipboard. Paste it here using Ctrl+V (Cmd+V on Mac).\n\nHighlight and delete these instructions before pasting your meme.\n\n";
			document.getElementById("uploadStatus").innerText = "‚úÖ Meme copied to clipboard! Paste it into the email using Ctrl+V (Cmd+V on Mac).";
		} else {
			document.getElementById("uploadStatus").innerText = "‚ùå Clipboard image copy is not supported. Attach manually.";
		}

		const recipient = pageTitle.toLowerCase().includes("trump")
			? "president@whitehouse.gov"
			: "elon@example.com";
		const encodedSubject = urlEncode("You're #1");
		const encodedBody = legacyURLEncode(`${postContent}\n\n${pasteInstructions}`);

		const mailtoLink = `mailto:${recipient}?subject=${encodedSubject}&body=${encodedBody}`;

		// Open email client and log action
		window.location.href = mailtoLink;
		await logIpAction('email', pageTitle); // ‚úÖ Log successful email action
	} catch (error) {
		console.error("Email or clipboard error:", error);
		document.getElementById("uploadStatus").innerText = `‚ùå Email failed: ${error.message}`;
	}
	await restoreButtons(); // üî• Restore all buttons
}

async function twitterMeme() {
	disableAllButtons();

    const fileInput = document.getElementById("memeFile");
    const file = fileInput.files[0];
    const postContent = encodeURIComponent(document.getElementById("postContent").value);
    
    if (!file) {
        document.getElementById("uploadStatus").innerText = "‚ùå No file selected.";
		await restoreButtons();
        return;
    }
	if (!postContent) {
		console.error("No post content provided.");
		document.getElementById("uploadStatus").innerText = "‚ùå Please enter some text for your post.";
        await restoreButtons(); // üî• Restore all buttons
		return;
	}
	if (!await validateBeforeAction("twitter")) {
		await restoreButtons();
		return;
	}
    if (!visionCheckPassed) {
        document.getElementById("uploadStatus").innerText = "‚ùå You must select a valid image first.";
		await restoreButtons();
        return;
    }

    // Upload Image First
    const formData = new FormData();
    formData.append("file", file);
    formData.append("action", "upload_twitter_meme");

    try {
        const response = await fetch("/wp-admin/admin-ajax.php", {
            method: "POST",
            body: formData
        });

        const data = await response.json();
        if (data.success) {
            const imageUrl = encodeURIComponent(data.data.url);
            const tweetUrl = `https://twitter.com/intent/tweet?text=${postContent}&url=${imageUrl}`;
            window.open(tweetUrl, '_blank');
        } else {
            document.getElementById("uploadStatus").innerText = "‚ùå Twitter upload failed.";
        }
    } catch (error) {
        document.getElementById("uploadStatus").innerText = "‚ùå Twitter upload error.";
    }
	await restoreButtons();
}

// ‚úÖ Upload Function
async function uploadMeme() {
	disableAllButtons();
	
	const pageTitle = document.title;
	const uploadAllowed = await checkIpLimit('upload', pageTitle);
	const fileInput = document.getElementById("memeFile");
	const file = fileInput.files[0];
	const postContent = document.getElementById("postContent").value.trim();
	const nonce = document.getElementById("memeUploadNonce").value;

	if (!file) {
		console.error("No file selected.");
		document.getElementById("uploadStatus").innerText = "‚ùå Please select a file.";
        await restoreButtons(); // üî• Restore all buttons
		return;
	}
	if (!postContent) {
		console.error("No post content provided.");
		document.getElementById("uploadStatus").innerText = "‚ùå Please enter some text for your post.";
        await restoreButtons(); // üî• Restore all buttons
		return;
	}
	if (!await validateBeforeAction("upload")) {
        await restoreButtons(); // üî• Restore all buttons
		return;
	}
    if (!visionCheckPassed) {
        document.getElementById("uploadStatus").innerText = "‚ùå You must select a valid image first.";
        await restoreButtons(); // üî• Restore all buttons
        return;
    }

    if (!uploadAllowed) {
        document.getElementById("uploadStatus").innerText = 
            `‚ùå Upload limit reached for "${pageTitle}". You can only upload one meme every 12 hours on this page.`;
        await restoreButtons();
        return;
    }

    // Use await to ensure attemptDetection and performUpload complete before restoring buttons
    const isGestureDetected = await attemptDetection(file, 1);
    if (!isGestureDetected) {
        let gestureType = pageTitle.indexOf("NOT") > -1 ? "middle finger" : "thumbs up";
        document.getElementById("uploadStatus").innerText = `‚ùå Upload rejected: No ${gestureType} detected.`;
        await restoreButtons();
        return;
    }
    
    // Perform the upload and log the IP action
    await performUpload(file, postContent, nonce, 1, pageTitle);
    
    // Now call restoreButtons; enforceIpLimitsOnLoad (called inside restoreButtons) will check the new IP limit state
    await restoreButtons();
}

// ‚úÖ Perform Upload with Page Title
async function performUpload(file, postContent, nonce, attempt, pageTitle) {
	const uploadButton = document.getElementById("uploadMemeButton");
	const formData = new FormData();
	formData.append("file", file);
	formData.append("post_content", postContent);
	formData.append("action", "upload_meme");
	formData.append("nonce", nonce);

	try {
		const response = await fetch("/wp-admin/admin-ajax.php", {
			method: "POST",
			body: formData
		});
		const data = await response.json();

		if (data.success) {
			document.getElementById("uploadStatus").innerHTML = `‚úÖ Meme uploaded successfully! <br> <a href="${data.data.url}" target="_blank">View Meme</a>`;
			await logIpAction('upload', pageTitle); // ‚úÖ Log successful upload action
		} else {
			if (attempt < 2) {
				await performUpload(file, postContent, nonce, attempt + 1, pageTitle);
			} else {
				document.getElementById("uploadStatus").innerText = `‚ùå Upload failed: ${data.data.message || "Unknown error"}`;
			}
		}
	} catch (error) {
		if (attempt < 2) {
			await performUpload(file, postContent, nonce, attempt + 1, pageTitle);
		} else {
			document.getElementById("uploadStatus").innerText = `‚ùå Upload error: ${error.message}`;
		}
	}
}


// ‚úÖ URL Encoding Functions
function urlEncode(text) {
	return encodeURIComponent(text);
}

function legacyURLEncode(text) {
	return escape(text);
}

// ‚úÖ Re-enable Upload and Email Buttons on Input Change
document.getElementById("memeFile").addEventListener("change", function () {
    document.getElementById("uploadStatus").innerText = "";
	previewImage();
});

document.getElementById("postContent").addEventListener("input", function () {
    document.getElementById("uploadStatus").innerText = "";
});

// ‚úÖ Preview Selected Image
function previewImage() {
	const fileInput = document.getElementById("memeFile");
	const previewContainer = document.getElementById("imagePreviewContainer");
	const previewImage = document.getElementById("imagePreview");

	if (!fileInput.files || fileInput.files.length === 0) {
		previewContainer.style.display = "none";
		return;
	}

	const file = fileInput.files[0];

	if (!file.type.startsWith("image/")) {
		document.getElementById("uploadStatus").innerText = "‚ùå Please select a valid image file.";
		previewContainer.style.display = "none";
		return;
	}

	const reader = new FileReader();
	reader.onload = function (e) {
		previewImage.src = e.target.result;
		previewContainer.style.display = "block";
	};

	reader.readAsDataURL(file);
}

// ‚úÖ Google Vision Validation
let lastValidatedFile = null;
let lastValidatedText = "";
let visionCheckPassed = false;

async function validateBeforeAction(actionType) {
    const fileInput = document.getElementById("memeFile");
    const file = fileInput.files[0];
    const currentText = document.getElementById("postContent").value.trim();

    // Check if the file or text actually changed
    const fileChanged = !lastValidatedFile || file?.name !== lastValidatedFile.name || file?.size !== lastValidatedFile.size;
    const textChanged = currentText !== lastValidatedText;

    if (fileChanged || textChanged) {
        // Reset validation and recheck
        visionCheckPassed = false;
        document.getElementById("uploadStatus").innerText = "üîç Revalidating changes...";

        // If a file exists, validate it
        if (file) {
            visionCheckPassed = await validateFileWithVision(file);
        }

        if (!visionCheckPassed) {
            document.getElementById("uploadStatus").innerText = "‚ùå Validation failed.";
            return false; // Stop the action
        }

        // Update the last validated state
        lastValidatedFile = file ? { name: file.name, size: file.size } : null;
        lastValidatedText = currentText;
    }

    return true; // Proceed with the action
}

// // ‚úÖ Validate File with Google Vision API
async function validateFileWithVision(file) {
    document.getElementById("uploadStatus").innerText = "üîç Validating image...";
    visionCheckPassed = false;

    const reader = new FileReader();
    return new Promise((resolve, reject) => {
        reader.onload = async function (event) {
            const base64Image = event.target.result.split(',')[1];

            try {
                const response = await fetch('/wp-admin/admin-ajax.php?action=analyze_image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_data: base64Image })
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById("uploadStatus").innerText = "‚úÖ Image approved!";
                    lastValidatedFile = { name: file.name, size: file.size };
                    visionCheckPassed = true;
                    resolve(true);
                } else {
                    document.getElementById("uploadStatus").innerText = `‚ùå Image rejected: ${result.message}`;
                    visionCheckPassed = false;
                    resolve(false);
                }
            } catch (error) {
                document.getElementById("uploadStatus").innerText = "‚ùå Error validating image. Try again.";
                visionCheckPassed = false;
                resolve(false);
            }
        };

        reader.onerror = (err) => {
            document.getElementById("uploadStatus").innerText = "‚ùå Error reading file.";
            visionCheckPassed = false;
            reject(err);
        };

        reader.readAsDataURL(file);
    });
}

// ‚úÖ Check if the File is the Same as Last Validated One
function isSameFile(file) {
    return lastValidatedFile && file.name === lastValidatedFile.name && file.size === lastValidatedFile.size;
}
	
// ‚úÖ Disable all buttons during processing
function disableAllButtons() {
    document.getElementById("uploadMemeButton").disabled = true;
    document.getElementById("emailMemeButton").disabled = true;
    document.getElementById("twitterMemeButton").disabled = true;
}

// ‚úÖ Restore button states after processing
async function restoreButtons(successButton = null) {
    await enforceIpLimitsOnLoad();
    if (successButton) {
        successButton.disabled = true;
    }
}

</script>