<!-- ‚úÖ Custom Meme Upload Form -->
<form id="memeUploadForm">
  <div class="form-group">
    <label for="memeFile">üìÅ Select Your Meme:</label>
    <input type="file" id="memeFile" accept="image/png, image/jpeg, image/gif" required onchange="previewImage()">
  </div>

  <div class="form-group">
    <label for="postContent">üìù Why are you posting this meme?:</label>
    <textarea id="postContent" rows="3" placeholder="Write something about your meme..." required></textarea>
  </div>

  <!-- ‚úÖ Hidden Nonce Field -->
  <input type="hidden" id="memeUploadNonce" value="">

  <!-- Added an id for clarity -->
  <button type="button" id="uploadMemeButton" class="save-btn" onclick="uploadMeme()">‚úÖ Upload Meme</button>

  <!-- ‚úÖ Upload Status -->
  <p id="uploadStatus"></p>

  <!-- ‚úÖ Image Thumbnail Preview -->
  <div id="imagePreviewContainer" style="display: none; margin-top: 10px;">
    <img id="imagePreview" src="" style="width: 150px; height: auto; border: 2px solid #ddd; padding: 5px; border-radius: 5px;">
  </div>
</form>

<style>
  /* ‚úÖ Ensure fields stack in vertical order */
  .form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 10px;
  }
  textarea {
    resize: vertical;
  }
  /* ‚úÖ Style for disabled button */
  .save-btn:disabled {
    background-color: #ccc;
    color: #666;
    cursor: not-allowed;
    opacity: 0.6;
  }
</style>

<script>
// ‚úÖ Get a fresh Nonce when the page loads
fetch('/wp-admin/admin-ajax.php?action=get_meme_nonce')
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.getElementById("memeUploadNonce").value = data.data.nonce;
    }
  })
  .catch(error => console.error("Nonce Error:", error));

/**
 * Detects the appropriate gesture based on the document title.
 * If the title contains "NOT", it uses middle finger detection,
 * otherwise it uses thumbs up detection.
 * @param {string} fileURL - The object URL for the file.
 * @returns {Promise<boolean>} - Resolves to true if the gesture is detected.
 */
function detectGestureFromFile(fileURL) {
  if (document.title.indexOf("NOT") > -1) {
    console.log("Using Middle Finger detection based on document title.");
    return detectMiddleFingerFromFile(fileURL);
  } else {
    console.log("Using Thumbs Up detection based on document title.");
    return detectThumbsUpFromFile(fileURL);
  }
}

/**
 * Helper function to attempt gesture detection up to 2 times.
 * @param {File} file - The file selected by the user.
 * @param {number} attempt - The current attempt number.
 * @returns {Promise<boolean>} - Resolves to true if detection succeeds.
 */
function attemptDetection(file, attempt) {
  // Create a fresh Blob each time for a new object URL.
  const fileBlob = new Blob([file], { type: file.type });
  const fileURL = URL.createObjectURL(fileBlob);
  console.log(`Attempt ${attempt}: Generated file URL:`, fileURL);

  return detectGestureFromFile(fileURL)
    .then((isDetected) => {
      console.log(`Attempt ${attempt}: Detection result:`, isDetected);
      URL.revokeObjectURL(fileURL);
      if (isDetected) {
        return true;
      } else if (attempt < 2) {
        console.log(`Detection failed on attempt ${attempt}. Retrying...`);
        return attemptDetection(file, attempt + 1);
      } else {
        console.log("Detection failed on final attempt.");
        return false;
      }
    })
    .catch((error) => {
      console.error(`Attempt ${attempt}: Error during detection:`, error);
      URL.revokeObjectURL(fileURL);
      if (attempt < 2) {
        console.log(`Error on attempt ${attempt}. Retrying detection...`);
        return attemptDetection(file, attempt + 1);
      } else {
        throw error;
      }
    });
}

function uploadMeme() {
  const uploadButton = document.getElementById("uploadMemeButton");
  uploadButton.disabled = true;

  const fileInput = document.getElementById("memeFile");
  const file = fileInput.files[0];
  console.log("Selected file:", file);

  const postContent = document.getElementById("postContent").value.trim();
  const nonce = document.getElementById("memeUploadNonce").value;

  if (!file) {
    console.error("No file selected.");
    document.getElementById("uploadStatus").innerText = "‚ùå Please select a file.";
    uploadButton.disabled = false;
    return;
  }
  if (!postContent) {
    console.error("No post content provided.");
    document.getElementById("uploadStatus").innerText = "‚ùå Please enter some text for your post.";
    uploadButton.disabled = false;
    return;
  }

  // Use the helper function to attempt detection (up to 2 times).
  attemptDetection(file, 1)
    .then((isGestureDetected) => {
      console.log("Final detection result:", isGestureDetected);
      if (!isGestureDetected) {
        console.error("Gesture not detected after 2 attempts.");
        // The error message now reflects the type of gesture expected.
        let gestureType = document.title.indexOf("NOT") > -1 ? "middle finger" : "thumbs up";
        document.getElementById("uploadStatus").innerText = `‚ùå Upload rejected: No ${gestureType} detected.`;
        uploadButton.disabled = false;
        return;
      }

      console.log("Gesture detected. Proceeding to upload...");
      performUpload(file, postContent, nonce, 1, uploadButton);
    })
    .catch((error) => {
      console.error("Error during gesture detection process:", error);
      document.getElementById("uploadStatus").innerText = "‚ùå Error during gesture detection.";
      uploadButton.disabled = false;
    });
}

// Helper function to perform the AJAX upload with a single retry.
function performUpload(file, postContent, nonce, attempt, uploadButton) {
  console.log("Uploading file. Attempt:", attempt, "File:", file);
  const formData = new FormData();
  formData.append("file", file);
  formData.append("post_content", postContent);
  formData.append("action", "upload_meme");
  formData.append("nonce", nonce);

  fetch("/wp-admin/admin-ajax.php", {
    method: "POST",
    body: formData,
  })
    .then(response => {
      console.log("Upload response received on attempt", attempt, ":", response);
      return response.json();
    })
    .then(data => {
      console.log("Upload JSON data:", data);
      if (data.success) {
        document.getElementById("uploadStatus").innerHTML = `‚úÖ Meme uploaded successfully! <br> <a href="${data.data.url}" target="_blank">View Meme</a>`;
        // Clear the file input upon successful upload.
        document.getElementById("memeFile").value = "";
      } else {
        if (attempt < 2) {
          console.warn("Upload failed on attempt", attempt, "retrying silently.");
          performUpload(file, postContent, nonce, attempt + 1, uploadButton);
        } else {
          console.error("Final upload attempt failed:", data.data.message);
          document.getElementById("uploadStatus").innerText = `‚ùå Upload failed: ${data.data.message || "Unknown error"}`;
          uploadButton.disabled = false;
        }
      }
    })
    .catch(error => {
      console.error("Upload error on attempt", attempt, ":", error);
      if (attempt < 2) {
        performUpload(file, postContent, nonce, attempt + 1, uploadButton);
      } else {
        document.getElementById("uploadStatus").innerText = `‚ùå Error: ${error.message}`;
        uploadButton.disabled = false;
      }
    });
}

// ‚úÖ Show the image preview as a small thumbnail.
function previewImage() {
  const fileInput = document.getElementById("memeFile");
  const previewContainer = document.getElementById("imagePreviewContainer");
  const previewImage = document.getElementById("imagePreview");

  if (!fileInput.files || fileInput.files.length === 0) {
    previewContainer.style.display = "none";
    return;
  }

  const file = fileInput.files[0];

  if (!file.type.startsWith("image/")) {
    document.getElementById("uploadStatus").innerText = "‚ùå Please select a valid image file.";
    previewContainer.style.display = "none";
    return;
  }

  const reader = new FileReader();
  reader.onload = function (e) {
    previewImage.src = e.target.result;
    previewContainer.style.display = "block";
  };

  reader.readAsDataURL(file);
}

// ‚úÖ Re-enable the upload button (and clear uploadStatus) if the user changes the file or text.
document.getElementById("memeFile").addEventListener("change", function() {
  const uploadButton = document.getElementById("uploadMemeButton");
  uploadButton.disabled = false;
  document.getElementById("uploadStatus").innerText = "";
});
document.getElementById("postContent").addEventListener("input", function() {
  const uploadButton = document.getElementById("uploadMemeButton");
  uploadButton.disabled = false;
  document.getElementById("uploadStatus").innerText = "";
});
</script>
